---
displayed_sidebar: docs
---

# Graceful Exit

v3.3以降、StarRocksはGraceful Exitをサポートしています。

## 概要

Graceful Exitは、StarRocks FE、BE、CNノードの**無停止アップグレードと再起動**をサポートするために設計されたメカニズムです。その主な目的は、ノードの再起動、ローリングアップグレード、クラスタのスケーリングなどのメンテナンス操作中に、実行中のクエリやデータ取り込みタスクへの影響を最小限に抑えることです。

Graceful Exitは以下を保証します。

- 終了が開始されると、ノードは**新しいタスクの受け入れを停止**します。
- 既存のクエリとロードジョブは、制御された時間枠内で**完了することが許可されます**。
- システムコンポーネント (FE/BE/CN) が**ステータス変更を調整**し、クラスタがトラフィックを正しく再ルーティングできるようにします。

Graceful Exitメカニズムは、以下に説明するように、FEとBE/CNノードで異なります。

### FE Graceful Exitメカニズム

#### トリガーシグナル

FE Graceful Exitは以下によって開始されます。

```bash
stop_fe.sh -g
```

これは`SIGUSR1`シグナルを送信し、デフォルトの終了（`-g`オプションなし）は`SIGTERM`シグナルを送信します。

#### ロードバランサー認識

シグナルを受信すると：

- FEは`/api/health`エンドポイントで直ちに**HTTP 500**を返します。
- ロードバランサーは約15秒以内に劣化状態を検出し、このFEへの新しい接続のルーティングを停止します。

#### コネクションドレインとシャットダウンロジック

**Follower FE**

- 読み取り専用クエリを処理します。
- FEノードにアクティブなセッションがない場合、接続は直ちに閉じられます。
- SQLが実行中の場合、FEノードはセッションを閉じる前に実行が終了するのを待ちます。

**Leader FE**

- 読み取りリクエストの処理はFollower FEと同じです。
- 書き込みリクエストの処理には以下が必要です。

  - BDBJEを閉じます。
  - 新しいLeader選出が完了するのを待ちます。
  - 後続の書き込みを新しく選出されたLeaderにリダイレクトします。

#### タイムアウト制御

クエリが長時間実行されすぎる場合、FEは**60秒**後に強制的に終了します（`--timeout`オプションで設定可能）。

### BE/CN Graceful Exitメカニズム

#### トリガーシグナル

BE Graceful Exitは以下によって開始されます。

```bash
stop_be.sh -g
```

CN Graceful Exitは以下によって開始されます。

```bash
stop_cn.sh -g
```

これは`SIGTERM`シグナルを送信し、デフォルトの終了（オプションなし）は`SIGKILL`シグナルを送信します。

#### 状態遷移

シグナルを受信した後：

- BE/CNノードは自身を**exiting**とマークします。
- **新しいクエリフラグメント**を`INTERNAL_ERROR`を返すことで拒否します。
- 既存のフラグメントの処理は継続します。

#### 実行中クエリの待機ループ

BE/CNが既存のフラグメントの終了を待機する動作は、BE/CN構成`loop_count_wait_fragments_finish`（デフォルト：2）によって制御されます。実際の待機時間は`loop_count_wait_fragments_finish × 10 seconds`（つまり、デフォルトで20秒）に等しくなります。タイムアウト後にフラグメントが残っている場合、BE/CNは通常のシャットダウン（スレッド、ネットワーク、その他のプロセスのクローズ）に進みます。

#### FE認識の改善

v3.4以降、FEはハートビート障害に基づいてBE/CNを`DEAD`とマークしなくなりました。FEはBE/CNの「exiting」状態を正しく認識し、フラグメントが完了するためのGraceful Exitウィンドウを大幅に長くすることができます。

## 設定

### FE設定

#### `stop_fe.sh -g --timeout`

- 説明：FEが強制終了されるまでの最大待機時間。
- デフォルト：60 (秒)
- 適用方法：スクリプトコマンドで指定します。例：`--timeout 120`。

#### *最小LB検出時間*

- 説明：LBがヘルス状態の劣化を検出するには、最低15秒が必要です。
- デフォルト：15 (秒)
- 適用方法：固定値

### BE/CN設定

#### `loop_count_wait_fragments_finish`

- 説明：既存のフラグメントに対するBE/CNの待機時間。この値に10秒を掛けます。
- デフォルト：2
- 適用方法：BE/CN設定ファイルを変更するか、動的に更新します。

#### `graceful_exit_wait_for_frontend_heartbeat`

- 説明：BE/CNがFEからのハートビートを通じて**SHUTDOWN**を確認するまで待機するかどうか。v3.4.5以降。
- デフォルト：false
- 適用方法：BE/CN設定ファイルを変更するか、動的に更新します。

#### `stop_be.sh -g --timeout`, `stop_cn.sh -g --timeout`

- 説明：BE/CNが強制終了されるまでの最大待機時間。BE/CNの待機時間に達する前に終了するのを防ぐため、`loop_count_wait_fragments_finish` * 10より大きい値を設定してください。
- デフォルト：false
- 適用方法：スクリプトコマンドで指定します。例：`--timeout 30`。

### グローバルスイッチ

Graceful Exitはv3.4以降**デフォルトで有効**です。一時的に無効にするには、BE/CN設定`loop_count_wait_fragments_finish`を`0`に設定します。

## Graceful Exit中の期待される動作

### クエリワークロード

| クエリタイプ                          | 期待される動作                                                                   |
| ----------------------------------- | ----------------------------------------------------------------------------------- |
| **短い (20秒未満)**                  | BE/CNは十分長く待機するため、クエリは通常通り完了します。                          |
| **中程度 (20〜60秒)**                | BE/CNの待機時間内に完了したクエリは成功を返します。それ以外の場合、クエリはキャンセルされ、手動での再試行が必要です。 |
| **長い (60秒以上)**                  | クエリはタイムアウトによりFE/BE/CNによって終了される可能性が高く、手動での再試行が必要です。 |

### データ取り込みタスク

- **FlinkまたはKafka Connectorsを介したロードタスク**は自動的に再試行され、ユーザーに目に見える中断はありません。
- **Stream Load (非フレームワーク)、Broker Load、Routine Loadタスク**は、接続が切断された場合に失敗する可能性があります。手動での再試行が必要です。
- **バックグラウンドタスク**は、FEの再試行メカニズムによって自動的に再スケジュールされ、実行されます。

### アップグレードおよび再起動操作

Graceful Exitは以下を保証します。

- クラスタ全体のダウンタイムなし。
- ノードを1つずつドレインすることによる安全なローリングアップグレード。

## 制限事項とバージョンによる違い

### バージョンの動作の違い

| バージョン   | 動作                                                                                                                  |
| --------- | ------------------------------------------------------------------------------------------------------------------------- |
| **v3.3**  | BE Graceful Exitに欠陥あり：FEがBE/CNを`DEAD`と prematurely マークし、クエリがキャンセルされる可能性があります。実質的な待機時間は制限されます（デフォルト15秒）。 |
| **v3.4+** | 拡張された待機時間を完全にサポート。FEはBE/CNの「exiting」状態を正しく識別します。本番環境での使用を推奨します。         |

### 運用上の制限

- 極端なケース（例えば、BE/CNがハングする）では、Graceful Exitが失敗する可能性があります。プロセスを終了するには`kill -9`が必要となり、部分的なデータ永続性（スナップショットで回復可能）のリスクがあります。

## 使用方法

### 前提条件

**StarRocksバージョン**：

- **v3.3+**：Graceful Exitの基本的なサポート。
- **v3.4+**：強化されたステータス管理、より長い待機時間（数分まで）。

**構成**：

- `loop_count_wait_fragments_finish`が正の整数に設定されていることを確認してください。
- `graceful_exit_wait_for_frontend_heartbeat`を`true`に設定し、FEがBEの「EXITING」状態を検出できるようにします。

### FE Graceful Exitの実行

```bash
./bin/stop_fe.sh -g --timeout 60
```

パラメーター：

- `--timeout`：FEノードが強制終了されるまでの最大待機時間。

動作：

- システムは最初に`SIGUSR1`シグナルを送信します。
- タイムアウト後、`SIGKILL`にフォールバックします。

#### FEステータスの検証

以下のAPIを通じてFEのヘルス状態を確認できます。

```
http://<fe_host>:8030/api/health
```

LBは、連続して200以外の応答を受信した後、ノードを削除します。

### BE/CN Graceful Exitの実行

- **v3.3の場合**：

  - BE：

  ```bash
  ./be/bin/stop_be.sh -g
  ```

  - CN：

  ```bash
  ./be/bin/stop_cn.sh -g
  ```

- **v3.4+の場合**：

  - BE：

  ```bash
  ./bin/stop_be.sh -g --timeout 600
  ```

  - CN：

  ```bash
  ./bin/stop_cn.sh -g --timeout 600
  ```

フラグメントが残っていない場合、BE/CNは直ちに終了します。

#### BE/CNステータスの検証

FEで実行：

```sql
SHOW BACKENDS;
```

`StatusCode`：

- `SHUTDOWN`：BE/CN Graceful Exitが進行中。
- `DISCONNECTED`：BE/CNノードが完全に終了しました。

## ローリングアップグレードワークフロー

### 手順

1. ノード`A`でGraceful Exitを実行します。
2. ノード`A`がFE側から`DISCONNECTED`として表示されていることを確認します。
3. ノード`A`をアップグレードして再起動します。
4. 残りのノードについても上記を繰り返します。

### Graceful Exitの監視

FEログ`fe.log`、BEログ`be.log`、またはCNログ`cn.log`をチェックして、終了中にタスクがあったかどうかを確認します。

## トラブルシューティング

### BE/CNがタイムアウトで終了する

タスクがGraceful Exit期間内に完了しなかった場合、BE/CNは強制終了（`SIGKILL`）をトリガーします。これがタスクの実行時間が長すぎるためか、または設定が不適切（例えば、`--timeout`の値が小さすぎる）であるためかを検証してください。

### ノードステータスがSHUTDOWNではない

ノードステータスが`SHUTDOWN`ではない場合、`loop_count_wait_fragments_finish`が正の整数に設定されているか、またはBE/CNが終了前にハートビートを報告したかどうか（報告していない場合は`graceful_exit_wait_for_frontend_heartbeat`を`true`に設定）を検証してください。
